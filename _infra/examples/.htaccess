# ReStandard - URL正規化ルール
# Apache用の.htaccessファイル
# サーバーにアップロードする際は、このファイルをプロジェクトルートに配置してください

RewriteEngine On

# ==========================================
# 1. HTTP -> HTTPS リダイレクト
# ==========================================
RewriteCond %{HTTPS} off
RewriteRule ^ https://%{HTTP_HOST}%{REQUEST_URI} [L,NE,R=301]

# ==========================================
# 2. www -> non-www 統一（非wwwに統一）
# 逆の場合は、RewriteCondとRewriteRuleを入れ替えてください
# ==========================================
RewriteCond %{HTTP_HOST} ^www\.(.*)$ [NC]
RewriteRule ^ https://%1%{REQUEST_URI} [L,NE,R=301]

# ==========================================
# 3. index.html を除去（ルートURLへ）
# ==========================================
RewriteCond %{THE_REQUEST} ^[A-Z]{3,9}\ /.*index\.html\ HTTP/
RewriteRule ^(.*/)index\.html$ /$1 [L,NE,R=301]

# ==========================================
# 4. 大文字を小文字へ変換
# ==========================================
RewriteCond %{REQUEST_URI} [A-Z]
RewriteRule (.*) ${lowercase:$1} [L,NE,R=301]

# 大文字小文字変換のマップ（Apache 2.4+）
RewriteMap lowercase int:tolower

# ==========================================
# 5. 連続スラッシュを除去
# ==========================================
RewriteCond %{REQUEST_URI} ^(.*)//+(.*)$
RewriteRule ^(.*)//+(.*)$ /$1/$2 [L,NE,R=301]

# ==========================================
# 6. 末尾スラッシュの統一（ディレクトリは/、ファイルは拡張子あり）
# ==========================================
# ディレクトリの場合は末尾スラッシュを追加
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_URI} !(.*)/$
RewriteRule ^(.*)$ /$1/ [L,R=301]

# ファイルの場合は末尾スラッシュを除去
RewriteCond %{REQUEST_FILENAME} -f
RewriteCond %{REQUEST_URI} (.*)/$
RewriteRule ^(.*)/$ /$1 [L,R=301]

# ==========================================
# 7. 不要なクエリパラメータの除去（utm等）
# ==========================================
# 注意：このルールは慎重に使用してください
# 実際のサイトで必要なパラメータがある場合は除外する必要があります
# RewriteCond %{QUERY_STRING} ^(.*)(utm_source|utm_medium|utm_campaign|utm_term|utm_content|fbclid|gclid)(=.*)$
# RewriteRule ^(.*)$ /$1? [L,R=301]

# ==========================================
# 8. キャッシュヘッダー（オプション）
# ==========================================
<IfModule mod_expires.c>
  ExpiresActive On
  ExpiresByType image/jpg "access plus 1 year"
  ExpiresByType image/jpeg "access plus 1 year"
  ExpiresByType image/gif "access plus 1 year"
  ExpiresByType image/png "access plus 1 year"
  ExpiresByType image/webp "access plus 1 year"
  ExpiresByType image/svg+xml "access plus 1 year"
  ExpiresByType text/css "access plus 1 month"
  ExpiresByType application/javascript "access plus 1 month"
  ExpiresByType text/html "access plus 0 seconds"
</IfModule>

# ==========================================
# 9. Gzip圧縮（オプション）
# ==========================================
<IfModule mod_deflate.c>
  AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css text/javascript application/javascript application/json
</IfModule>

